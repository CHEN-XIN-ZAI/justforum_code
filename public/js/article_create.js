!function(t){var e={};function r(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(a,n,function(e){return t[e]}.bind(null,n));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e),$(document).ready((function(){!function(){var t=$("#category option:selected").data("tag");if(void 0!==t){t=t.split(" ");for(let e=0;e<t.length-1;e++)0==e?$("#category_tag").append("<option selected>"+t[e]+"</option>"):$("#category_tag").append("<option>"+t[e]+"</option>")}}(),$("#category").change((function(t){t.preventDefault();var e=$("#category option:selected").data("tag");e=e.split(" "),$("#category_tag").html("");for(let t=0;t<e.length-1;t++)$("#category_tag").append('<option value="">'+e[t]+"</option>")})),$("#add-tag div button").click((function(t){t.preventDefault();var e=$("#tag input").attr("value").split(" ").length,r=$("#add-tag input").val();e>5?alert("標籤最多5個"):""==r?alert("不可為空!!"):-1!==$("#tag input").attr("value").indexOf(r)?alert("已經有重複的標籤"):($("#tag").append('<button class="btn btn-primary btn-sm p-1 mr-1">'+r+"</button>"),$("#tag input").attr("value",$("#tag input").val()+r+" "))})),$("#this-tag-add").click((function(t){t.preventDefault();var e=$("#tag input").attr("value").split(" ").length,r=$("#category_tag option:selected").text();e>5?alert("標籤最多5個"):-1!==$("#tag input").attr("value").indexOf(r)?alert("已經有重複的標籤"):($("#tag").append('<button class="btn btn-primary btn-sm p-1 mr-1">'+r+"</button>"),$("#tag input").attr("value",$("#tag input").val()+r+" "))})),$("#tag").click((function(t){if(t.preventDefault(),"BUTTON"===t.target.nodeName){var e=$("#tag input").attr("value").split(t.target.textContent+" ");e=e.join(""),$("#tag input").attr("value",e),$(t.target).remove()}})),$("#article_create").submit((function(t){let e=editor.getData(),r=document.createElement("div");r.innerHTML=e;var a=$("#tag input").attr("value").split(" ");if(a.length>=6&&Boolean(a[5]))return alert("標籤最多5個"),void t.preventDefault();if(e){let t=$(r).find("h2,p,h3,h4").text().substr(0,80),a=$(r).find("img").attr("src")||"",n="/-justforum-/";$("#article_content").val(e+n+t+n+a)}else alert("沒有文章內容!!"),t.preventDefault()}));class t{constructor(t){this.loader=t}upload(){return this.loader.file.then(t=>new Promise((e,r)=>{this._initRequest(),this._initListeners(e,r,t)}))}abort(){this.xhr&&this.xhr.abort()}_initRequest(){$("#create_article").text("圖片上傳中.."),$("#create_article").attr("disabled","");const t=this.xhr=new XMLHttpRequest;t.open("POST","/article/image",!0),t.responseType="json"}_initListeners(t,e,r){const a=this.xhr,n=this.loader,o=`無法上傳文件: ${r.name}.`;if(a.addEventListener("error",()=>e(o)),a.addEventListener("abort",()=>e()),a.addEventListener("load",()=>{const r=a.response;if(!r||r.error)return alert(r.error||"圖片上傳失敗!!"),$("#create_article").text("儲存"),$("#create_article").removeAttr("disabled"),e(r&&r.error?r.error.message:o);$("#create_article").text("儲存"),$("#create_article").removeAttr("disabled"),t({default:r.url})}),r){let t="jpg jpeg png gif bmp".split(" "),n=!1;if(t.forEach(t=>{-1!==r.type.indexOf(t)&&(n=!0)}),n){let t=new FileReader;t.readAsDataURL(r),t.onload=function(){const t=new FormData;if(r.size/1024>1025){let e=new Image;e.src=this.result,e.onload=function(){let e=this,r=e.width,n=e.height,o=r/n;e.width>e.height?n=(r=e.width>1920?1920:e.width)/o:r=(n=e.height>1080?1080:e.height)*o;let i=document.createElement("canvas"),l=i.getContext("2d"),u=document.createAttribute("width");u.nodeValue=r;let d=document.createAttribute("height");d.nodeValue=n,i.setAttributeNode(u),i.setAttributeNode(d),l.drawImage(e,0,0,r,n);let c=i.toDataURL("image/jpeg",.7);const s=atob(c.split(",")[1]),p=[];for(let t=0;t<s.length;t+=512){const e=s.slice(t,t+512),r=new Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);const a=new Uint8Array(r);p.push(a)}const g=new Blob(p,{type:c.split(",")[0].split(";")[0].split(":")[1]});t.append("photo",g),a.send(t)}}else t.append("photo",r),a.send(t)}}else e("您選擇的圖檔不支援，或並不是圖檔，僅支援jpg png gif bmp格式的圖檔。")}a.upload&&a.upload.addEventListener("progress",t=>{t.lengthComputable&&(n.uploadTotal=t.total,n.uploaded=t.loaded)})}}ClassicEditor.create(document.querySelector("#editor"),{toolbar:{viewportTopOffset:$(".navbar-dark").height()+2},extraPlugins:[function(e){e.plugins.get("FileRepository").createUploadAdapter=function(e){return new t(e)}}],imageUpload:{uploadUrl:$("#editor").data("url")+"/article/image"}}).then(t=>{window.editor=t}).catch(t=>{console.log(t)})}))}]);